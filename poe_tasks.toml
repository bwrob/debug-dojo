[executor]
    type = "uv"

    # =============================================================================
    # Git Hooks
    # =============================================================================

[tasks.precommit]
    help  = "Run all pre-commit hooks on all files."
    shell = "pre-commit run --all-files > /dev/null || pre-commit run --all-files"

    # =============================================================================
    # Code Quality
    # =============================================================================

[tasks.format]
    cmd  = "ruff format --diff"
    help = "Check code formatting using ruff."

[tasks.lint]
    cmd  = "ruff check --config ruff.toml"
    help = "Check code rules using ruff."

[tasks.type-check]
    cmd  = "basedpyright --project pyrightconfig.json src tests"
    help = "Check static typing using basedpyright."

[tasks.complexity]
    default_item_type = "cmd"
    help = "Check code complexity using complexipy."
    sequence = [
        "complexipy .",
        "ruff check . --select=PLR0912",
    ]

[tasks.dependencies]
    cmd  = "tach check"
    help = "Check dependency layers using tach."

[tasks.fix]
    default_item_type = "cmd"
    help = "Code quality fixes using ruff."
    ignore_fail = "return_non_zero"
    sequence = [
        "ruff check --fix --unsafe-fixes",
        "ruff format",
    ]

[tasks.code-quality]
    help = "Run all code quality checks."
    ignore_fail = "return_non_zero"
    sequence = [
        "fix",
        "precommit",
        "format",
        "lint",
        "type-check",
        "complexity",
    ]
    verbosity = -1

    # =============================================================================
    # Testing
    # =============================================================================

[tasks.test]
    cmd  = "pytest"
    help = "Run tests using pytest."

[tasks.coverage]
    cmd  = "pytest --doctest-modules --verbose --cov --cov-report=xml"
    help = "Create test coverage report."

    # =============================================================================
    # Documentation
    # =============================================================================

[tasks.generate-banner]
    cmd  = "python scripts/compile_banner.py"
    help = "Generate the banner image from Typst source."

[tasks.dependency-graph]
    cmd  = "tach show --mermaid -o docs/dependency_graph.mmd"
    help = "Generate the dependency graph."

[tasks.docs]
    help = "Spawn docs server."
    sequence = [
        "generate-banner",
        { cmd = "hap run mkdocs serve" },
    ]

[tasks.publish-docs]
    help = "Publish the docs to GitHub Pages."
    sequence = [
        "generate-banner",
        { cmd = "mkdocs gh-deploy --force" },
    ]

    # =============================================================================
    # Release
    # =============================================================================

[tasks.publish]
    help = "Build and publish the package."
    sequence = [
        "code-quality",
        { cmd = "rm -rf dist" },
        { cmd = "uv build" },
        { cmd = "uv publish" },
        "publish-docs",
    ]
